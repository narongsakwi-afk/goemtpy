<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡πÄ‡∏Å‡∏°‡∏´‡∏°‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏° (Go) - Final Version</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root{--board-size:15;--cell-size:28px;--color-light-bg:#f9f9f9;--color-dark-bg:#e0e0e0;--color-board:#f7d794;--color-wood-dark:#b8860b;--color-button:#4a90e2;--color-button-hover:#357ABD;--color-black:#000;--color-white:#fff;--font-family:'Kanit',sans-serif}body{font-family:var(--font-family);display:flex;flex-direction:column;align-items:center;padding:10px;margin:0;background-color:var(--color-dark-bg);min-height:100vh;color:#333}h1,h2,h3{font-weight:600;color:#1e3a5f;margin-bottom:15px}#home-view,#lobby-view,#game-view,#waiting-room-view{display:none;width:100%;max-width:1200px;align-items:center;flex-direction:column;padding:15px}#home-view.active,#lobby-view.active,#game-view.active,#waiting-room-view.active{display:flex}.card{background-color:var(--color-white);border-radius:12px;box-shadow:0 8px 16px rgba(0,0,0,.15);padding:25px;margin-bottom:20px;width:100%;box-sizing:border-box}#home-view input,#create-room-section input{padding:10px;margin:5px 0 15px 10px;border:1px solid #ccc;border-radius:6px;font-size:16px;width:60%}button{padding:12px 25px;font-size:18px;margin:10px 8px;cursor:pointer;border:none;border-radius:8px;font-weight:600;transition:background-color .3s,transform .1s}button:disabled{background-color:#ccc;cursor:not-allowed}#online-players-section{text-align:left}#online-list{list-style-type:none;padding-left:0}#online-list li{padding:5px 0;border-bottom:1px solid #f0f0f0;color:#2e7d32;font-weight:500}#online-list li::before{content:'üü¢ '}#room-list{display:flex;flex-direction:column;gap:15px;margin-top:10px}.room-item{display:flex;justify-content:space-between;align-items:center;padding:15px;background-color:#f9f9f9;border-radius:8px;border:1px solid #eee}.player-slots{display:flex;justify-content:space-around;width:100%;margin:20px 0}.player-slot{width:45%;padding:20px;border:1px solid #ddd;border-radius:8px;text-align:center}.status-indicator{display:inline-block;padding:5px 12px;border-radius:15px;font-size:.9em;font-weight:600;background-color:#f8d7da;color:#721c24}.status-indicator.ready{background-color:#d4edda;color:#155724}#game-view{flex-direction:row;align-items:flex-start;position:relative}#player-info-container{width:220px;flex-shrink:0;margin-right:20px}.player-info-card{background:#fff;padding:15px;border-radius:8px;margin-bottom:15px;box-shadow:0 2px 4px rgba(0,0,0,.05)}#game-container{flex-shrink:0;text-align:center}#controls-panel{min-width:250px;text-align:center}#board{display:grid;grid-template-columns:repeat(var(--board-size),1fr);width:calc(var(--board-size) * var(--cell-size));height:calc(var(--board-size) * var(--cell-size));background-color:var(--color-board);border:4px solid var(--color-wood-dark)}.intersection{border-right:1px solid #333;border-bottom:1px solid #333;cursor:pointer;box-sizing:border-box;display:flex;justify-content:center;align-items:center;position:relative}.stone{width:80%;height:80%;border-radius:50%;position:absolute;box-shadow:0 2px 4px rgba(0,0,0,.4),inset 0 0 5px rgba(255,255,255,.4)}
        #developer-credit {position: fixed; bottom: 10px; right: 15px; font-size: 0.8em; color: #777; z-index: 9999;}
    </style>
</head>
<body>

    <div id="home-view" class="card active">
        <h2>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡πÄ‡∏Å‡∏°‡∏´‡∏°‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏° (Go)</h2>
        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏•‡πá‡∏≠‡∏ö‡∏ö‡∏µ‡πâ</p>
        <input type="text" id="main-player-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" required>
        <button onclick="enterLobby()">üö™ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏•‡πá‡∏≠‡∏ö‡∏ö‡∏µ‡πâ</button>
    </div>

    <div id="lobby-view" class="card">
        <h2>Lobby</h2>
        <p>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, <strong id="lobby-player-name"></strong>!</p>
        <div id="online-players-section" class="card">
            <h3>üë• ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (<span id="online-count">0</span>)</h3>
            <ul id="online-list"></ul>
        </div>
        <div id="create-room-section" class="card">
            <h3>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</h3>
            <input type="text" id="room-name-input" placeholder="‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á..." required>
            <button onclick="createRoom()">‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á</button>
        </div>
        <div id="open-rooms-section" class="card">
            <h3>‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ( <span id="room-count">0</span> )</h3>
            <div id="room-list"></div>
        </div>
    </div>

    <div id="waiting-room-view" class="card">
        <h2>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏≠‡πÄ‡∏•‡πà‡∏ô: <span id="waiting-room-name"></span></h2>
        <div class="player-slots">
            <div class="player-slot"><p><strong>‚ö™ ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á</strong></p><p id="waiting-p1-name">...</p></div>
            <div class="player-slot">
                <p><strong>‚ö´ ‡∏ú‡∏π‡πâ‡∏ó‡πâ‡∏≤‡∏ä‡∏¥‡∏á</strong></p>
                <p id="waiting-p2-name">...‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠...</p>
                <div id="challenger-status-indicator" class="status-indicator">‡∏£‡∏≠</div>
            </div>
        </div>
        <div id="waiting-room-controls">
             <button id="start-game-btn" style="display:none;">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
             <button id="ready-btn" style="display:none;">‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°</button>
             <button onclick="leaveRoom()">üè† ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á</button>
        </div>
    </div>

    <div id="game-view">
        <div id="my-player-info" class="player-info-card">
            <h4 id="my-info-name">My Name</h4>
        </div>
        <div id="game-container">
            <div id="board"></div>
        </div>
        <div id="controls-panel">
            <div id="current-status" class="card">
                <p><strong>‡∏ï‡∏≤‡πÄ‡∏î‡∏¥‡∏ô:</strong> <span id="current-player-name"></span></p><hr>
                <p><strong>‡∏´‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö‡πÑ‡∏î‡πâ:</strong></p>
                <p>‚ö´ <span id="p1-captured">0</span> | ‚ö™ <span id="p2-captured">0</span></p><hr>
                <p><strong>‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß:</strong></p>
                <p>‚ö´ <span id="p1-pass-count">0</span>/5 | ‚ö™ <span id="p2-pass-count">0</span>/5</p><hr>
                <p><strong>‡∏´‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</strong></p>
                <p>‚ö´ <span id="p1-moves-left">100</span> | ‚ö™ <span id="p2-moves-left">100</span></p>
            </div>
            <div id="controls">
                <button onclick="passMove()">ü§ù ‡∏ú‡πà‡∏≤‡∏ô</button>
                <button onclick="surrender()">üè≥Ô∏è ‡∏¢‡∏≠‡∏°‡πÅ‡∏û‡πâ</button>
                <button onclick="leaveRoom()">üè† ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏Å‡∏°</button>
            </div>
        </div>
    </div>

    <div id="developer-credit">‡∏ú‡∏π‡πâ‡∏û‡∏±‡∏í‡∏ô‡∏≤: ‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå ‡∏ì‡∏£‡∏á‡∏Ñ‡πå‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå ‡∏ß‡∏¥‡∏£‡∏∏‡∏ì‡∏û‡∏±‡∏ô‡∏ò‡πå</div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let mainPlayerName = '';
        let currentRoomId = null;

        const views = ['home-view', 'lobby-view', 'game-view', 'waiting-room-view'];
        const boardElement = document.getElementById('board');

        function showView(viewId) {
            views.forEach(id => document.getElementById(id).classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }

        function enterLobby() {
            const nameInput = document.getElementById('main-player-name').value;
            if (!nameInput.trim()) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì');
            mainPlayerName = nameInput.trim();
            document.getElementById('lobby-player-name').textContent = mainPlayerName;
            socket.emit('player_online', mainPlayerName); 
            gotoLobby();
        }
        
        function gotoLobby() {
            showView('lobby-view');
            socket.emit('get_rooms');
            currentRoomId = null;
        }
        
        function createRoom() {
            const roomName = document.getElementById('room-name-input').value.trim();
            if (!roomName) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á');
            socket.emit('create_room', { name: roomName, host: mainPlayerName });
        }
        
        function joinRoom(roomId) {
            socket.emit('join_room', { roomId, playerName: mainPlayerName });
        }

        function leaveRoom() {
            socket.emit('leave_room');
            gotoLobby();
        }
        
        function renderWaitingRoom(room) {
            currentRoomId = room.id;
            showView('waiting-room-view');
            document.getElementById('waiting-room-name').textContent = room.name;
            document.getElementById('waiting-p1-name').textContent = room.host;
            document.getElementById('waiting-p2-name').textContent = room.challenger || '...‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô...';
            
            const statusIndicator = document.getElementById('challenger-status-indicator');
            if (room.challengerReady) {
                statusIndicator.textContent = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß';
                statusIndicator.classList.add('ready');
            } else {
                statusIndicator.textContent = '‡∏£‡∏≠';
                statusIndicator.classList.remove('ready');
            }

            const isHost = mainPlayerName === room.host;
            const startBtn = document.getElementById('start-game-btn');
            const readyBtn = document.getElementById('ready-btn');

            startBtn.style.display = isHost ? 'inline-block' : 'none';
            startBtn.disabled = !room.challengerReady;
            startBtn.onclick = () => socket.emit('start_game', currentRoomId);

            readyBtn.style.display = !isHost && room.challenger === mainPlayerName ? 'inline-block' : 'none';
            readyBtn.disabled = room.challengerReady;
            readyBtn.onclick = () => socket.emit('player_ready', currentRoomId);
        }

        function createBoardGrid() {
            boardElement.innerHTML = "";
            for (let r = 0; r < 15; r++) {
                for (let c = 0; c < 15; c++) {
                    const cell = document.createElement("div");
                    cell.className = "intersection";
                    cell.onclick = () => socket.emit('make_move', { roomId: currentRoomId, r, c });
                    boardElement.appendChild(cell);
                }
            }
        }

        function updateGameUI(state) {
            const { boardState, currentPlayer, playerNames, moveCounts, passCounts, capturedStones } = state;
            let i = 0;
            for(let r=0; r<15; r++) { for(let c=0; c<15; c++) {
                const cell = boardElement.children[i]; if(!cell) continue; cell.innerHTML = "";
                if (boardState[r] && boardState[r][c] !== 0) {
                    const stone = document.createElement("div");
                    stone.className = `stone ${boardState[r][c] === 1 ? 'black' : 'white'}`;
                    cell.appendChild(stone);
                } i++;
            }}
            document.getElementById('current-player-name').textContent = playerNames[currentPlayer];
            document.getElementById('p1-captured').textContent = capturedStones['1'];
            document.getElementById('p2-captured').textContent = capturedStones['2'];
            document.getElementById('p1-pass-count').textContent = passCounts['1'];
            document.getElementById('p2-pass-count').textContent = passCounts['2'];
            document.getElementById('p1-moves-left').textContent = moveCounts['1'];
            document.getElementById('p2-moves-left').textContent = moveCounts['2'];
            const myColor = playerNames['1'] === mainPlayerName ? 1 : 2;
            document.getElementById('my-info-name').textContent = `${myColor === 1 ? '‚ö´' : '‚ö™'} ${mainPlayerName}`;
        }
        
        function passMove() { socket.emit('pass_move', currentRoomId); }
        function surrender() { if(confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏¢‡∏≠‡∏°‡πÅ‡∏û‡πâ?')) socket.emit('surrender', currentRoomId); }

        socket.on('update_online_players', (players) => {
            const list = document.getElementById('online-list');
            const count = document.getElementById('online-count');
            list.innerHTML = ''; count.textContent = players.length;
            players.forEach(name => { const li = document.createElement('li'); li.textContent = name; list.appendChild(li); });
        });

        socket.on('update_room_list', (rooms) => {
            const list = document.getElementById('room-list');
            const count = document.getElementById('room-count');
            const available = rooms.filter(r => !r.gameStarted);
            list.innerHTML = ''; count.textContent = available.length;
            available.forEach(room => {
                const item = document.createElement('div');
                item.className = 'room-item';
                let actionBtn = room.challenger ? `<button disabled>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠</button>` : `<button class="btn-join" onclick="joinRoom('${room.id}')">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</button>`;
                item.innerHTML = `<div><strong>${room.name}</strong><br><span>‡πÇ‡∏î‡∏¢: ${room.host}</span></div> ${actionBtn}`;
                list.appendChild(item);
            });
        });
        
        socket.on('update_waiting_room', (room) => renderWaitingRoom(room));

        socket.on('game_started', (room) => {
            currentRoomId = room.id;
            showView('game-view');
            createBoardGrid();
            updateGameUI(room.gameState);
        });

        socket.on('update_game_state', (gameState) => { updateGameUI(gameState); });
        socket.on('game_over', ({ winner, reason }) => { alert(`‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡πâ‡∏ß!\n‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞: ${winner}\n‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${reason}`); gotoLobby(); });
        socket.on('invalid_move', ({ error }) => { alert(`‡∏ß‡∏≤‡∏á‡∏´‡∏°‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ${error}`); });
        socket.on('redirect_to_lobby', () => { gotoLobby(); });

        showView('home-view');
    </script>
</body>
</html>
